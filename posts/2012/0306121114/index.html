<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Webアプリのパフォーマンスアップ作戦 - ゆーすけべー日記</title><link rel="icon" type="image/png" href=icons/myicon.png /><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="Webアプリのパフォーマンスアップ作戦" />
<meta property="og:description" content=" 予定している機能を実現するアプリが完成するだけでWebサービスが成り立つわけではありません。運用の最中にパフォーマンスにまつわる問題が出てくる可能性があります。それは突然大きなトラフィックがやってきたというような時だけではありません。知識" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://yusukebe.com/posts/2012/0306121114/" />
<meta property="og:image" content="https://yusukebe.com/icons/myicon.png"/>
<meta property="article:published_time" content="2012-03-06T21:11:00+09:00" />
<meta property="article:modified_time" content="2012-03-06T21:11:00+09:00" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://yusukebe.com/icons/myicon.png"/>

<meta name="twitter:title" content="Webアプリのパフォーマンスアップ作戦"/>
<meta name="twitter:description" content=" 予定している機能を実現するアプリが完成するだけでWebサービスが成り立つわけではありません。運用の最中にパフォーマンスにまつわる問題が出てくる可能性があります。それは突然大きなトラフィックがやってきたというような時だけではありません。知識"/>
<link rel="stylesheet" type="text/css" media="screen" href="https://yusukebe.com/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://yusukebe.com/css/main.css" />
	<link rel="stylesheet" type="text/css" href="https://yusukebe.com/css/custom.css" />
	
	<link rel="stylesheet" type="text/css" href="https://yusukebe.com/css/syntax.css" />
	<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
	<script src="https://yusukebe.com/js/main.js"></script>
	<script src="https://code.jquery.com/jquery-3.4.1.js"></script>
</head>

<body>
	<div class="container wrapper post">
		<div class="header">
	<h1 class="site-title"><a href="https://yusukebe.com/">ゆーすけべー日記</a></h1>
	<div class="site-description"><h2></h2><nav class="nav social">
			<ul class="flat"><a href="https://github.com/yusukebe" title="Github"><i data-feather="github"></i></a><a href="https://twitter.com/yusukebe" title="Twitter"><i data-feather="twitter"></i></a></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/">Home</a>
			</li>
			
			<li>
				<a href="/posts">All posts</a>
			</li>
			
			<li>
				<a href="/about">About</a>
			</li>
			
			<li>
				<a href="/tags">Tags</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post-header">
			<h1 class="title">Webアプリのパフォーマンスアップ作戦</h1>
			<div class="meta">Posted at &mdash; Mar 6, 2012</div>
		</div>

		<div class="markdown post-body">
			

<p>予定している機能を実現するアプリが完成するだけでWebサービスが成り立つわけではありません。
運用の最中にパフォーマンスにまつわる問題が出てくる可能性があります。
それは突然大きなトラフィックがやってきたというような時だけではありません。
知識が無いうちですと、いざ運用に乗せてみるとずいぶんとサイトの読み込みが遅いといったケースが発生することもあります。</p>

<p>僕はいくつかのエロサイトを管理しているのですが、
その中に月間700万PVのアクセスをいただいている「サイトA」があります。
サイトAの場合、トラフィックもそこまで無かった当初からパフォーマンスに関する問題がいくつか発生し、
その都度調べては実践で試して対策をしてきました。また、できる限り少ないリソースでの運用を目指しています。
今回はWebアプリのパーフォマンスアップ作戦として、
サイトAでの運用経験からのいくつかの方針やTipsを紹介したいと思います。</p>

<hr>

<p><br></p>

<h4>それはどこのパフォーマンス問題？</h4>

<p>まず、パフォーマンスといってもWebアプリの場合、どこがボトルネックになっているか？
その「どこ」を把握することが大事です。単に「Webサイトが遅いよ」と言っても、
Webページ自体のレスポンスを返すのが遅いのか、ページ内で使われている画像の配信が遅いのか、描画が遅いのか...
様々なケースが考えられます。
そこで、大きく切り分けて以下の3つでパフォーマンスを考えるといいと思っています。</p>

<ul>
<li>バックエンド、アプリ部分のリクエストを処理する際の性能</li>
<li>フロントエンド、アプリ部分以外のページ全体を構成するパーツ郡の配信性能</li>
<li>クライアント、ページ全体を描画する際にクライアントにどれだけ負荷をかけるかの性能</li>
</ul>


<p>今回はあえて、フロントエンドとクライアントを分けて考えています。
クライアントは人間がページを見る場合ですと、
昨今、マシンの性能が上がっているので、ある程度負荷をかけてもいいところかもしれませんが、意識することは必要です。</p>

<h4>バックエンドの性能計測</h4>

<p>パフォーマンスに対する問題を解決するには、対策と結果をどちらも把握しなくてはいけません。
それには結果に対する計測が必要になってきます。ちなみに、最初に言っておきますと、
計測の原則として常に同じ環境で計測するというのが前提となってきます。</p>

<p>さて、バックエンドの性能を計測するには一般的にApache Benchmark「ab」というコマンドが使われています。
その名の通りApacheに付属しているツールです。</p>

<p>「<a href="http://127.0.0.1:5000/">http://127.0.0.1:5000/</a>」にリクエストしてパフォーマンスを計測するには以下のようなコマンドを実行します。</p>

<pre> $ ab -n 100 -c 10 "http://127.0.0.1:5000/"
 </pre>

<p>オプションの「-n」はリクエストの回数、「-c」は同時接続数を意味します。結果は以下のように出力されます。</p>

<pre> Benchmarking 127.0.0.1 (be patient).....done

Server Software:        
Server Hostname:        127.0.0.1
Server Port:            5000

Document Path:          /
Document Length:        271 bytes

Concurrency Level:      10
Time taken for tests:   0.227 seconds
Complete requests:      100
Failed requests:        0
Write errors:           0
Total transferred:      44000 bytes
HTML transferred:       27100 bytes
Requests per second:    440.95 [#/sec] (mean)
Time per request:       22.678 [ms] (mean)
Time per request:       2.268 [ms] (mean, across all concurrent requests)
Transfer rate:          189.47 [Kbytes/sec] received

Connection Times (ms)
              min  mean[+/-sd] median   max
Connect:        0    2   4.4      0      20
Processing:     4   20  12.8     20     104
Waiting:        0   19  12.7     19     103
Total:          4   22  13.1     22     104

Percentage of the requests served within a certain time (ms)
  50%     22
  66%     23
  75%     24
  80%     26
  90%     36
  95%     46
  98%     56
  99%    104
 100%    104 (longest request)
 </pre>

<p>ここで注目したいのは「Request per second」という欄ですね。</p>

<pre> Requests per second:    440.95 [#/sec] (mean)
 </pre>

<p>これは秒間に「440.95リクエスト」を処理しているということを意味しています。
「Hello World」程度のWebアプリなので速い数字が出てます。
この数字は複雑な処理をしたり、データベースアクセスやWeb APIへの接続をするアプリになってくると、
極端に小さくなっていきます。つまりアプリの処理速度が低下することを意味します。
サービスの規模や処理内容によるのでどういう数値が適切かはケースバイケースですが、
バックエンドのパフォーマンス計測に使う値の一つです。</p>

<h4>Webサーバの構成</h4>

<p>「サイトA」はPerl製のPSGI互換Webアプリとしてつくられています。
よって様々なWebアプリケーションサーバで起動することができるのですが、サイトAの場合は「Starman」を使用しています。
このStarmanで立ち上げているアプリだけでサイト内のコンテンツを全て配信して完結させることは可能ですが、
フロントエンドサーバとして「nginx」を構えさせています。
nginxがCSSや画像ファイルなどの静的コンテンツの配信とリバースプロキシによるバックエンド、
つまりStarmanとのつなぎをしています。</p>

<p><img src="http://farm8.staticflickr.com/7045/6958632065_4d8ce12f0d.jpg" alt="サーバ構成"></p>

<p>Starmanなどで起動するアプリサーバのプロセスがどうしてもメモリを占有してしまうために、
画像などのアクセスの多いコンテンツはフロントエンドに任せています。
サイトAの場合だとStarmanの子プロセスが一つ50MBほどになってしまいますから、
静的ファイルを全てアプリケーションサーバで配信すると大変なのです。
このような構成にすることで、最小限の動的コンテンツ部分をアプリケーションサーバで担うことになって、
プロセス数の把握がしやすくなり、プリフォークさせるプロセス数の調整がしやすくなります。</p>

<h4>アプリケーションでのキャッシュ</h4>

<p>アプリケーションでのキャッシュをすることはバックエンドの性能を向上させる常套手段でもあります。
キャッシュプログラムでよく使うのは「set」と「get」で、それぞれ簡単な概念です。
とあるキーを指定して、値をキャッシュするにはこのようなプログラムになるでしょう。</p>

<pre>  $cache-&gt;set('key', $value);
 </pre>

<p>値を取り出す時は、</p>

<pre> my $cached_value = $cache-&gt;get('key');
 </pre>

<p>とします。memcachedなどを利用した場合、「set」する際にキャッシュの有効期限を指定することができます。
例えば、24時間だけ値をキャッシュしたい時には</p>

<pre> $cache-&gt;set('key', $value, 60 * 60 * 24);
 </pre>

<p>と、秒単位で時間を記述します。この有効期限を利用して、
サイト内で頻繁にアクセスのあるデータをある一定時間キャッシュさせるということをサイトAでは行っています。</p>

<pre> my $data = $cache-&gt;get('key');
return $data if $data;
$data = $api-&gt;get_data();
$cache-&gt;set('key', $data, 60 * 60 * 24);
return $data;
 </pre>

<p>このコードは、もし、キャッシュにヒットしたらその値を即座に返し、そうじゃなかったらデータを取得し、
キャッシュに設定するということを意味しています。
このコードはよく使うパターンです。</p>

<p>また、データのキャッシュよりも効果的なのは、制限が多くなりますが、
HTMLのページをまるごともしくは一部をキャッシュする方法です。
Web Application Framework内でビューを通してレンダリングした結果をキャッシュに乗せてそれを利用すればよいでしょう。</p>

<h4>クライアント側でのパフォーマンス計測と対策</h4>

<p>静的コンテンツの配信、そしてそれの描画に関するクライアント側での最終的なパフォーマンス計測には、
ブラウザのアドオンであるYahoo! YSlowやGoogle Page Speedなどが利用されています。
対象となるサイトをブラウザ開きつつアドオンを起動すると様々なチューニングポイントと共に、
「A」とか「C」とかアルファベットでスコアを付けてくれます。
ちなみに今、サイトAのランクを計ったら「B」のスコアをいただきました。</p>

<p><img src="http://farm8.staticflickr.com/7205/6812552230_03f061c682.jpg" alt="YSlow"></p>

<p>これを「A」にしなくてはいけないというわけでは決してないです。
それぞれのチューニングポイントは、サイトによって達成しなくていい項目も含まれているからです。</p>

<p>僕は最低限、自分がフロントエンドサーバで配信するコンテンツに関しての「header」調整はします。
特に「expires header」を適切に設定することでクライアント側に画像やCSSなどのファイルのキャッシュをすることができます。
サイトAでは極力長く1年間のexpiresを設定しています。nginxのコンフィグファイルは以下のように記述しています。</p>

<pre> location ~ ^/(favicon.ico|images|js|css)/  {
    expires 1y;
}
 </pre>

<p>注意したいのはこちらが意図的に「/css/style.css」を書き換えたとすると、
そのファイルのクライアント側のキャッシュを解除しなくてはいけません。
対象となるCSSを読み込むHTMLでファイル名にパラメータを付加することで強制的に書き換えた新しいものを読み込ませています。</p>

<pre> &lt;link rel="stylesheet" href="/css/style.css?v=0002" /&gt;
 </pre>

<p>クライアントサイドに関して様々な環境が存在するので、ある程度慎重にパフォーマンスを改善していくことがいいと思います。
ちなみにフロントとクライアントサイドのチューニングについては以下の書籍が詳しいです。</p>

<div class="amazlet-box" style="margin-bottom:0px;">
<div class="amazlet-image" style="float:left;margin:0px 12px 1px 0px;"><a href="http://www.amazon.co.jp/exec/obidos/ASIN/487311361X/kamawada-22/ref=nosim/" name="amazletlink" target="_blank"><img src="http://ecx.images-amazon.com/images/I/51hIDIWHmYL._SL160_.jpg" alt="ハイパフォーマンスWebサイト ―高速サイトを実現する14のルール" style="border: none;"></a></div>
<div class="amazlet-info" style="line-height:120%; margin-bottom: 10px">
<div class="amazlet-name" style="margin-bottom:10px;line-height:120%">
<a href="http://www.amazon.co.jp/exec/obidos/ASIN/487311361X/kamawada-22/ref=nosim/" name="amazletlink" target="_blank">ハイパフォーマンスWebサイト ―高速サイトを実現する14のルール</a><div class="amazlet-powered-date" style="font-size:80%;margin-top:5px;line-height:120%">posted with <a href="http://www.amazlet.com/browse/ASIN/487311361X/kamawada-22/ref=nosim/" title="ハイパフォーマンスWebサイト ―高速サイトを実現する14のルール" target="_blank">amazlet</a> at 12.03.06</div>
</div>
<div class="amazlet-detail">Steve Souders スティーブ サウダーズ <br>オライリージャパン <br>売り上げランキング: 91462<br>
</div>
<div class="amazlet-sub-info" style="float: left;"><div class="amazlet-link" style="margin-top: 5px"><a href="http://www.amazon.co.jp/exec/obidos/ASIN/487311361X/kamawada-22/ref=nosim/" name="amazletlink" target="_blank">Amazon.co.jp で詳細を見る</a></div></div>
</div>
<div class="amazlet-footer" style="clear: left"></div>
</div>


<p><br></p>

<h4>まとめ</h4>

<p>他にもサーバ構成をより見直すことができますし、非同期で処理するべき点はそうすべきかもしれませんし、
データベースアクセスなどは簡単に改善ポイントであります。
サイトAを例に取りましたが、やり方は色々あるので一つの参考にしてください。
また、Web上にも似たような事例、もっと大規模なチューニング事例が多く掲載されているのでそちらも見てみるとよいと思います。</p>

<h4>お知らせ</h4>

<p>メルマガ「ゆーすけべーラジオ」でもWebアプリのつくり方を連載しています。よろしければお試し購読を！</p>

<ul>
<li><a href="http://www.mag2.com/m/0001426750.html" title="ゆーすけべーラジオ">ゆーすけべーラジオ</a></li>
</ul>



		</div>

		<div class="post-tags">
			
				
					<nav class="nav tags">
							<ul class="flat">
								
								<li><a href="/tags/web-essay">Web Essay</a></li>
								
								<li><a href="/tags/technologies">Technologies</a></li>
								
							</ul>
					</nav>
				
			
		</div>
        <div id="fb-root"></div>
<script async defer crossorigin="anonymous" src="https://connect.facebook.net/ja_JP/sdk.js#xfbml=1&version=v5.0&appId=233306523373884&autoLogAppEvents=1"></script>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>

<div class="social-button-area">
  <ul class="social-button">
    <li>
      <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-show-count="false">Tweet</a>
    </li>
    <li>
      <span class="fb-share-button"  data-layout="button" data-size="small"><a target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fyusukebe.com%2fposts%2f2012%2f0306121114%2f;src=sdkpreparse" class="fb-xfbml-parse-ignore">シェア</a></span>
    </li>
    <li>
      <a href="https://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="basic-label-counter" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/v4/public/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a>
    </li>
  </ul>
</div>

<div class="disqus-area">
  <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "yusukebe-com" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

<ul class="pagination">
  
  <li class="page-item page-prev">
    <a href="https://yusukebe.com/posts/2012/0305211542/" class="page-link" aria-label="Previous"><span aria-hidden="true">← 全裸で学ぶMVC事始め</span></a>
  </li>
  
  
  <li class="page-item page-next">
    <a href="https://yusukebe.com/posts/2012/0309014143/" class="page-link" aria-label="Next"><span aria-hidden="true">iPhoneアプリ「僕のラジオ」をリリースしました →</span></a>
  </li>
  
</ul>

	</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div> © Copyright yusukebe.com |  <a href="https://github.com/vividvilla/ezhil">Ezhil theme</a> | Built with <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-492497-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

<script>feather.replace()</script>
</body>
</html>
