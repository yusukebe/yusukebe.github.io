{
    "data" :  {
    "title": "Amazonアソシエイト決算2007.11を発表するテスト",
    "date": "2007-12-06 20:32:00 +0900 JST",
    "dir": "posts/2007/",
    "slug": "1206113225",
    "categories": ["tech"],
    "tags": ["Perl"]
}

---



<p>
Danさんの真似をして「Amazonの2007年11月分の決算の集計が終わったので結果を発表します。」というこのエントリーを書くために、
AmazonアソシエイトからのレポートをXMLで取得して、パースしてHTMLに書きだすというPerlのスクリプトを書いた。で、みてみた。所詮、俺なんかの範疇では3位くらいまでしかちゃんと格付けできないことがわかった。
そして、エロDVDがたくさん売れてた。
</p>
<p>
というしょぼいランキングですが、せっかく作ったので、1位から3位を紹介します。
エロDVDはその中には含まれていないので心配ご無用です。
</p>
<p>
  えー、1位は「<strong>いかにして問題をとくか</strong>」でした。
「<a href="http://yusukebe.com/archives/07/10/15/174049.html">ゆーすけべー日記: いかにして効率よく大量のおっぱい画像をダウンロードするか</a>」というエントリーに張ったのが功を奏し結構売れてます。
実際、いい本なので、まだ味読の人は是非。
個人的には、3位以内には入っていませんが、
「<a href="http://yusukebe.com/archives/07/10/21/185609.html">ゆーすけべー日記: "Welcome To The Black Parade" - My Chemical Romance</a>」で紹介したマイケミの「<a href="http://www.amazon.co.jp/exec/obidos/ASIN/B000JLSVH4/kamawada-22/">ザ・ブラック・パレード</a>」が売れたのが嬉しいです。
</p>
<ul>
<li style="margin-bottom:10px;">
<a href="http://www.amazon.co.jp/exec/obidos/ASIN/4621045938/kamawada-22/"><img align="left" class="at-xid-6a0133f4781589970b014e8bd74874970d" src="https://yusukebe.com/archives/a/6a0133f4781589970b014e8bd74874970d-pi.jpg" style="margin-right:20px"></a>
<a href="http://www.amazon.co.jp/exec/obidos/ASIN/4621045938/kamawada-22/">いかにして問題をとくか</a><br>
1位だよ！<br>
[<a href="http://yusukebe.com/archives/07/11/05/101509.html">本日記による言及</a>]
<br clear="all">
</li>
<li style="margin-bottom:10px;">
<a href="http://www.amazon.co.jp/exec/obidos/ASIN/4797339497/kamawada-22/"><img align="left" class="at-xid-6a0133f4781589970b014e8bd74880970d" src="https://yusukebe.com/archives/a/6a0133f4781589970b014e8bd74880970d-pi.jpg" style="margin-right:20px"></a>
<a href="http://www.amazon.co.jp/exec/obidos/ASIN/4797339497/kamawada-22/">あなたはコンピュータを理解していますか? 10年後、20年後まで必ず役立つ根っこの部分がきっちりわかる！ (サ</a><br>
2位だよ！<br>
[<a href="http://yusukebe.com/archives/07/11/05/101509.html">本日記による言及</a>]
<br clear="all">
</li>
<li style="margin-bottom:10px;">
<a href="http://www.amazon.co.jp/exec/obidos/ASIN/B00005H013/kamawada-22/"><img align="left" class="at-xid-6a0133f4781589970b014e8bd7488d970d" src="https://yusukebe.com/archives/a/6a0133f4781589970b014e8bd7488d970d-pi.jpg" style="margin-right:20px"></a>

<a href="http://www.amazon.co.jp/exec/obidos/ASIN/B00005H013/kamawada-22/">星がきれい</a><br>
2位だよ！<br>
[本日記による言及はないよ]
<br clear="all">
</li>
<li style="margin-bottom:10px;">
<a href="http://www.amazon.co.jp/exec/obidos/ASIN/4826901380/kamawada-22/"><img align="left" class="at-xid-6a0133f4781589970b014e8bd74894970d" src="https://yusukebe.com/archives/a/6a0133f4781589970b014e8bd74894970d-pi.jpg" style="margin-right:20px"></a>
<a href="http://www.amazon.co.jp/exec/obidos/ASIN/4826901380/kamawada-22/">メタマス!―オメガをめぐる数学の冒険</a><br>
3位だよ！<br>
[本日記による言及はないよ]
<br clear="all">
</li>
<li style="margin-bottom:10px;">
<a href="http://www.amazon.co.jp/exec/obidos/ASIN/B000BKJHOO/kamawada-22/"><img align="left" class="at-xid-6a0133f4781589970b014e8bd748ab970d" src="https://yusukebe.com/archives/a/6a0133f4781589970b014e8bd748ab970d-pi.jpg" style="margin-right:20px"></a>
<a href="http://www.amazon.co.jp/exec/obidos/ASIN/B000BKJHOO/kamawada-22/">仙界伝 封神演義 外伝新章</a><br>
3位だよ！<br>
[本日記による言及はないよ]
<br clear="all">
</li>
<li style="margin-bottom:10px;">
<a href="http://www.amazon.co.jp/exec/obidos/ASIN/B000QXRJLY/kamawada-22/"><img align="left" class="at-xid-6a0133f4781589970b014e8bd748b5970d" src="https://yusukebe.com/archives/a/6a0133f4781589970b014e8bd748b5970d-pi.jpg" style="margin-right:20px"></a>
<a href="http://www.amazon.co.jp/exec/obidos/ASIN/B000QXRJLY/kamawada-22/">ファイナルファンタジーXI アルタナの神兵 拡張データディスク</a><br>
3位だよ！<br>
[本日記による言及はないよ]
<br clear="all">
</li>
</ul>
<p>
日記で言及してなくても結構売れたりするものですね。
ちなみに、Amazonが出力するreport.xmlをパースしてHTMLに書き出すPerlのスクリプトはこんな感じです。
中古で売れた本の重複を防いだり、順位付けをするため、ちょっと長くなってます。
</p>
<pre class="brush: perl"> #!/usr/bin/perl

use strict;
use warnings;
use XML::XPath;
use XML::XPath::XMLParser;
use Template;
use Unicode::RecursiveDowngrade;

my $xp = XML::XPath-&gt;new( filename =&gt; 'report.xml' );
my $nodeset = $xp-&gt;find('//Item');
my @lists;
foreach my $node ( $nodeset-&gt;get_nodelist ) {
    #print Dumper($node);
    my %attribute;
    foreach my $attr ( @{$node-&gt;find('@*')} ){
    $attribute{$attr-&gt;getName} = $attr-&gt;getNodeValue;
    }
    push(@lists, \%attribute);
}

my @items;
foreach my $list (@lists) {
    my $flag = 1;
    foreach my $item (@items) {
    if( $list-&gt;{Title} eq $item-&gt;{Title}){
        $item-&gt;{Qty} ++;
        $flag = 0;
        last;
    }
    }
    push(@items, $list) if $flag;
}

@items = sort { $b-&gt;{Qty} &lt;=&gt; $a-&gt;{Qty} } @items;

my $num = $items[0]-&gt;{Qty};
my $no = 1;

foreach my $item (@items) {
    if( $item-&gt;{Qty} == $num ) {
    $item-&gt;{No} = $no;
    }else{
    $num --;
    $no ++;
    $item-&gt;{No} = $no;
    }
}

my $rd = Unicode::RecursiveDowngrade-&gt;new;
my $ref = $rd-&gt;downgrade(\@items);

my $tt = Template-&gt;new;
$tt-&gt;process(\*DATA,{items=&gt;$ref})
    || die $tt-&gt;error(), "\n";

__DATA__
&lt;ul&gt;
[% FOREACH item = items -%]
&lt;li style="margin-bottom:10px;"&gt;
&lt;a href="http://www.amazon.co.jp/exec/obidos/ASIN/[% item.ASIN %]/kamawada-22/"&gt;
&lt;img src="http://images.amazon.com/images/P/[% item.ASIN %].01._SCTHUMBZZZ_.jpg" align="left" /&gt;
&lt;/a&gt;
&lt;a href="http://www.amazon.co.jp/exec/obidos/ASIN/[% item.ASIN %]/kamawada-22/"&gt;
[% item.Title %]&lt;/a&gt;&lt;br /&gt;
[% item.No %]位だよ！
&lt;br clear="all"/&gt;
&lt;/li&gt;
[% END -%]
&lt;/ul&gt;</pre>


 
}
