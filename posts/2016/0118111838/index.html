<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Golangを初めて本番投入したぜ！ - ゆーすけべー日記</title>
    <meta name="description" content=" 先日「ボケて」サービス群の中でも「スタンプ」という機能を提供するアプリサーバがGo実装になりました。これが僕にとってほぼ初めての「Golang実戦投入」となります。Goの良さについては去年の10月に僕がやっているPodcast「wada." /><link rel="icon" type="image/png" href=icons/myicon.png /><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="Golangを初めて本番投入したぜ！" />
<meta property="og:description" content=" 先日「ボケて」サービス群の中でも「スタンプ」という機能を提供するアプリサーバがGo実装になりました。これが僕にとってほぼ初めての「Golang実戦投入」となります。Goの良さについては去年の10月に僕がやっているPodcast「wada." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://yusukebe.com/posts/2016/0118111838/" /><meta property="og:image" content="https://yusukebe.com/icons/myicon.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2016-01-18T11:18:00&#43;09:00" />
<meta property="article:modified_time" content="2016-01-18T11:18:00&#43;09:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://yusukebe.com/icons/myicon.png"/>

<meta name="twitter:title" content="Golangを初めて本番投入したぜ！"/>
<meta name="twitter:description" content=" 先日「ボケて」サービス群の中でも「スタンプ」という機能を提供するアプリサーバがGo実装になりました。これが僕にとってほぼ初めての「Golang実戦投入」となります。Goの良さについては去年の10月に僕がやっているPodcast「wada."/>
<link rel="stylesheet" type="text/css" media="screen" href="https://yusukebe.com/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://yusukebe.com/css/main.css" />
	<link rel="stylesheet" type="text/css" href="https://yusukebe.com/css/custom.css" />
	
	<link rel="stylesheet" type="text/css" href="https://yusukebe.com/css/syntax.css" />
    <script src="//cdn.embedly.com/widgets/platform.js" charset="UTF-8"></script>
	<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
	<script src="https://yusukebe.com/js/main.js"></script>
	<script src="https://code.jquery.com/jquery-3.4.1.js"></script>
</head>

<body>
	<div class="container wrapper post">
		<div class="header">
	<h1 class="site-title"><a href="https://yusukebe.com/">ゆーすけべー日記</a></h1>
	<div class="site-description"><h2>天然パーマです。</h2><nav class="nav social">
			<ul class="flat"><a href="https://github.com/yusukebe" title="Github"><i data-feather="github"></i></a><a href="https://twitter.com/yusukebe" title="Twitter"><i data-feather="twitter"></i></a></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/">Home</a>
			</li>
			
			<li>
				<a href="/posts">All posts</a>
			</li>
			
			<li>
				<a href="/about">About</a>
			</li>
			
			<li>
				<a href="/tags">Tags</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post-header">
			<h1 class="title">Golangを初めて本番投入したぜ！</h1>
			<div class="meta">Posted at &mdash; Jan 18, 2016</div>
		</div>

		<div class="markdown post-body">
			

<p>先日「ボケて」サービス群の中でも「スタンプ」という機能を提供するアプリサーバが<strong>Go実装</strong>になりました。これが僕にとってほぼ初めての「<strong>Golang実戦投入</strong>」となります。Goの良さについては去年の10月に僕がやっている<a href="http://www.wada.fm/entry/ep043">Podcast「wada.fm」でも言及していました</a>。ただ、単純に良いからと言って、本番への導入となると既にユーザーを抱えているので、敷居が高いと感じます。そこで、工夫しつつ、じっくりと試して、現在に至りました。後述するようにハマりどころはありましたが、そのGoサーバは安定稼働していて、ユーザーへコンテンツを配信しています。そこで今回は新規にGoを導入する際の一つの事例として、今回、僕がやったボケてのスタンプサーバリプレースの経緯を紹介します。</p>

<h2>LL言語への「若干の」不満</h2>

<p>まず...</p>

<blockquote><p>そもそもなんでGolangが必要なの？</p></blockquote>

<p>ってところ。ボケてのアプリケーションはほぼ全てが以前からPerlで書かれていて、キレイに本番で不具合も無く動いてくれていました。<code>Plack/PSGI</code>が登場してもはや久しく、アプリケーションサーバが安定し、また<code>App::cpanminus/Carton</code>といったモジュールインストーラやライブラリ管理も賢くやってくれます。ただ、これはLL全般に言えることなんですが、<strong>型が無い</strong>んですよね。</p>

<p>型がないってことは、サクッと書くときにはいいけど、堅牢にやりたい時に手間がかかります。 例えばPerlには<code>Data::Validator</code>というライブラリがあるので、それを使ってメソッドへの引数のタイプチェックなどを追加で実装していました。例えばボケて内の<code>lib/Bokete/Model/Boke.pm</code>には以下のようなコードが記載されています。</p>

<pre class="code lang-perl" data-lang="perl" data-unlink> sub create {
    state $rule = Data::Validator-&gt;new(
        text =&gt; 'Str',
        odai_id =&gt; 'Str',
        user_id =&gt; 'Str',
        category =&gt; { isa =&gt; 'Maybe[Str]', default =&gt; undef },
        tags =&gt; { isa =&gt; 'ArrayRef', default =&gt; sub { [] } }
    )-&gt;with('Method');
    my ($self, $args) = $rule-&gt;validate(@_);</pre>


<p>実装レベルでコードの中に出てくる「データ」もしくは「機能」それぞれに対して厳密にチェックしておきたい場合に、LLだと外部のライブラリを使う手間が生じたり、それが完璧に行われないケースがあるのです。逆に言えばそれがLLのいいところですが、使いドコロによってはより「strictに」やりたいアプリケーションもあるかと思うのです。</p>

<p>また、Perlは素晴らしく書きやすい言語だと思ってはいますが、他の違う言語も習得しておくと後々武器になって、楽しいんじゃないかなーって感じ、Goに手を出したという経緯になります。</p>

<h2>Goの魅力</h2>

<p>Golangを触ってみて良いなーって感じたことは前述した通り、wada.fmで話しております。興味のある方は聴いて下さい！</p>

<p><iframe src="http://www.wada.fm/embed/ep043" title="43. Go言語ファーストインプレッション - wada.fm" class="embed-card embed-blogcard" scrolling="no" frameborder="0" style="display: block; width: 100%; height: 190px; max-width: 500px; margin: 10px 0px;"></iframe><cite class="hatena-citation"><a href="http://www.wada.fm/entry/ep043">www.wada.fm</a></cite></p>

<p>ただ簡単に列挙するならば...</p>

<ul>
<li>静的型付け言語だけどスクリプトっぽくかけて<strong>とっつきやすい</strong>
</li>
<li>構造体にメソッド生やして「クラスのようなもの」を実現するとか「<strong>素朴</strong>」で良い</li>
<li>コードを簡潔にするという方針などが現れた「<strong>ツンデレ</strong>」なコンパイラ</li>
<li>
<code>goroutine</code>便利だし使いドコロが結構ある</li>
<li>Webサーバで負荷テストした時にCPUリソースをキッチリ使いきってくれて消費メモリも既存アプリと比べて少ない</li>
<li>言語仕様的にもミニマムで「<strong>組み合わせでなんとかする</strong>」って点がPerlっぽい</li>
<li>優良なライブラリもどんどん出てる</li>
</ul>


<p>などなど、でしょうかね。とにかく触ってみて、スッとコードを書き始めることが出来たのがよかったです。</p>

<h2>Goをスクリプト的に利用する</h2>

<p>実は今回紹介するスタンプサーバ以前にボケてではGoを使っていました。ただプロダクトとしていつも動くサーバやバッチ、という形では無く、書捨ての「<strong>スクリプトっぽい</strong>」コードを利用してたのです。</p>

<p>例えばRDBMSのとあるテーブルの構造を変えて、データ移行したい場合においてです。なんでGolangをそこで使うのか？というと<code>goroutine</code>があるからです。Goだと<code>go</code>というキーワードだけで並行処理が走り、かつデータベース接続もロックせずよしなにやってくれるので、MySQLサーバの負荷の様子を見ながら並行数を調整することで「ある程度の負荷をかけながら」素早くデータ移行が出来て便利でした。以下のように<code>sync.WaitGroup</code>でその<code>goroutine</code>で平行に走らせる処理数を調整しています。</p>

<pre class="code lang-go" data-lang="go" data-unlink> for ;; {
  var results []Entry
  err = db.Select(&amp;results, db.Where("column1".IsNull()), db.Limit(limit));
  if err != nil {
    panic(err)
  }
  if len(results) == 0 {
    break
  }
  var wg sync.WaitGroup
  for _, e := range(results) {
    wg.Add(1)
    go func(entry Entry) {
      work(entry)
      wg.Done()
    }(e)
  }
  wg.Wait()
}</pre>


<p>このように最初はスクリプト的にGoを使ってみて感触を掴んでみました。</p>

<h2>どこからGolang化していくか？</h2>

<p>さて、Goのパフォーマンス性能を活かせて、かつ、現行で走っているサービスに影響がなければ、Golang化したいところ。ただ、移行のコストとかも考えると全てをGoにするのは大変だし、Perlの方が得意なところもあるのでその辺は見極めなくてはいけません。ボケてではMicroservicesという言葉が流行る以前から、ある程度サービスをHTTPレイヤーで切ったコンポーネント化を進めておりました。そこで、大きな部分を一気に変更する、のではなく、<strong>小さな一部分だけを違う実装に変える</strong>ということが容易です。そこで、目をつけたのが<strong>スタンプサーバ</strong>です。</p>

<p>ボケてではボケのコンテンツを画像として保存したりLINEで送る機能があります。「スタンプ」と呼んでいるのはまさに「LINEスタンプ」からインスプレーションを受けています。ようはボケの対象となるお題画像とその他ボケのテキストなどをコアロジックのWeb APIサーバから引っ張り、画像生成して、配信する機能が実装されています。試しに新しいGolang実装のサーバから配信されているスタンプ画像を直で貼り付けてみるとこのような画像です。</p>

<p><a href="http://stamp.bokete.jp/1916834.png" class="http-image" target="_blank"><img src="http://stamp.bokete.jp/1916834.png" class="http-image" alt="http://stamp.bokete.jp/1916834.png"></a></p>

<p>このサービスはボケてのアプリの中でも「フロントエンドの1機能」としてPerlでつくられていましたが、ホストも違うし動かすサーバも違う。また、データはWeb APIから取得してくればOK！と、切り離しやすい箇所だったので、</p>

<blockquote><p>まさにここからGolang化を試してみよう</p></blockquote>

<p>となりました。</p>

<h2>スニペットを集める</h2>

<p>と言っても、いきなり画像処理や文字列の改行計算を含んだ「ひとつの」アプリケーションを書き始めるのはニュービーにとって漠然としすぎてて、ムリゲです。なので、スタンプサーバの実装要件をピックアップし、それごとに小さなGoコードの塊＝<strong>コードスニペット</strong>をたくさん書いていきました。スニペットが集まっているレポジトリから選んでみると...</p>

<ul>
<li>ローカルの画像をリサイズして書き出す</li>
<li>HTTP上の画像を取得して書き出す</li>
<li>ローカルの画像をWebで配信する</li>
<li>テキストを描画して画像として書き出す</li>
<li>改行を含んだテキストを処理する</li>
<li>日本語を含んだ文字列改行の禁則処理をする</li>
</ul>


<p>などです。おそらく一番に書いたコードはこんなものでした。リサイズ処理に<code>github.com/disintegration/imaging</code>を使っています。</p>

<pre class="code lang-go" data-lang="go" data-unlink> package main

import (
    "image"
    "github.com/disintegration/imaging"
    "fmt"
    "os"
)

func main() {
    args := os.Args
    if len(args) &lt; 2 {
        panic("The argument is required.")
    }
    filename := args[len(args)-1]
    fmt.Println("Input filename is:", filename)
    orgImg, err := imaging.Open(filename)
    if err != nil {
        panic(err)
    }
    dstImg := resize(orgImg, 600, 0)
    err = imaging.Save(dstImg, "output.jpg")
    if err != nil {
        panic(err)
    }
    fmt.Println("Resize as output.jpg.")
}

func resize(img image.Image, width int, height int) image.Image {
    dstImg := imaging.Resize(img, width, height, imaging.Lanczos)
    return dstImg.SubImage(dstImg.Rect)
}</pre>


<p>このようにスニペットを充実させていく作業をすると</p>

<blockquote><p>お、これは本番用のアプリも実装出来そうだぞ！</p></blockquote>

<p>と自信がついてきます。</p>

<h2>画像生成サーバの実装と運用</h2>

<p>そこでいよいよスタンプサーバの実装です。既に処理部分のスニペットがあるので、いかに個別のファイルにまとめてテストを書いて構造化するか？を考えればすんなりといけました。こんなファイル群で<code>stamp_server</code>コマンドをつくっています。</p>

<pre class="code" data-lang="" data-unlink> $ pwd
/Users/yusuke/go/src/github.com/bokete/webstamp
$ tree ./
./
├── README.md
├── assets
│   ├── font-heavy.ttf
│   ├── font-medium.ttf
│   ├── stamp_404.png
│   ├── stamp_footer.png
│   ├── stamp_header.png
│   ├── stamp_panel.png
│   └── transparent.png
├── assets.go
├── client.go
├── client_test.go
├── cmd
│   └── stamp_server
│       └── main.go
├── stamp.go
├── stamp_test.go
├── util.go
└── util_test.go </pre>


<p>デプロイはあまりベストプラクティスが共有されてない？っぽいので、少々悩みましたが、今まで通りAnsibleで以下の工程を自動化しています。</p>

<ul>
<li>要らないと思うけど「とりま」nginxをフロントに置く</li>
<li>スーパーデーモンには<code>daemontools</code>を使用</li>
<li>lestrratさん作の<a href="https://github.com/lestrrat/go-server-starter">go-server-starter</a>をベースにホットデプロイを実現する</li>
<li>上記ライブラリの<code>listener</code>をアプリ側に実装しておく</li>
<li>Perlアプリの時と同じく<code>server_starter</code>（Go実装）を利用してアプリを立ち上げる</li>
<li>アプリをアップデートする際はサーバ側の<code>GOROOT</code>内で<code>git pull</code>させて次に<code>go get</code>して<code>bin</code>以下にコマンドを生成</li>
<li>予め仕込んである<code>daemontools</code>ディレクトリを<code>$ svc -h /service/stamp_server</code>として<code>graceful restart</code>
</li>
</ul>


<p>現状のコードだと<code>graceful shutdown</code>にはうまく対応出来てない疑惑がありますが、画像配信サーバーですし、間に短いTTLを仕込んだCDNを挟んでますし、なんとかなります。</p>

<h2>ハマりどころ</h2>

<p>一番最初、デプロイしてしばらくたつと、</p>

<blockquote><p>あれ〜、やけに詰まるな〜 Goだとパフォーマンス悪くなるのかな〜？</p></blockquote>

<p>なんて自体に陥りましたが、これは別段Golangのせいでは無く、僕が書いていた禁則処理のロジックで稀に無限ループをつくってしまうバグが潜んでいただけでした。「あるある〜！」そう<strong>言語が悪いんじゃないんです、自分が悪かった</strong>のです。</p>

<p>と、まぁそこが大きな躓きポイントなだけであとは十分パフォーマンス出てますし、不具合もなく快適なアプリになりました！</p>

<h2>まとめ</h2>

<p>ボケてにおいてスタンプサーバをGo実装で書き直して、<strong>Go本番童貞を捨てた</strong>話を書きました。本番化しないと分からないことも結構あったので、やってよかったと思います。Perlと比べると言語の性質的に煩雑になるケースもありますが、<strong>コンパイルされる時点で「不本意なことを弾いてくれる」</strong>というのは強みであるし、単にGolangが気に入ったので、他のコンポーネントもジャッジ次第でGoで書いていきたいですね！</p>

<p></p>
<div class="hatena-asin-detail">
<a href="http://www.amazon.co.jp/exec/obidos/ASIN/4873117526/kamawada-22/"><img src="http://ecx.images-amazon.com/images/I/51UoREcNrnL._SL160_.jpg" class="hatena-asin-detail-image" alt="Go言語によるWebアプリケーション開発" title="Go言語によるWebアプリケーション開発"></a><div class="hatena-asin-detail-info">
<p class="hatena-asin-detail-title"><a href="http://www.amazon.co.jp/exec/obidos/ASIN/4873117526/kamawada-22/">Go言語によるWebアプリケーション開発</a></p>
<ul>
<li>
<span class="hatena-asin-detail-label">作者:</span> Mat Ryer,鵜飼文敏,牧野聡</li>
<li>
<span class="hatena-asin-detail-label">出版社/メーカー:</span> オライリージャパン</li>
<li>
<span class="hatena-asin-detail-label">発売日:</span> 2016/01/22</li>
<li>
<span class="hatena-asin-detail-label">メディア:</span> 大型本</li>
<li><a href="http://d.hatena.ne.jp/asin/4873117526/kamawada-22" target="_blank">この商品を含むブログを見る</a></li>
</ul>
</div>
<div class="hatena-asin-detail-foot"></div>
</div>

<p></p>
<div class="hatena-asin-detail">
<a href="http://www.amazon.co.jp/exec/obidos/ASIN/4863541783/kamawada-22/"><img src="http://ecx.images-amazon.com/images/I/511AaCXdmsL._SL160_.jpg" class="hatena-asin-detail-image" alt="改訂2版 基礎からわかる Go言語" title="改訂2版 基礎からわかる Go言語"></a><div class="hatena-asin-detail-info">
<p class="hatena-asin-detail-title"><a href="http://www.amazon.co.jp/exec/obidos/ASIN/4863541783/kamawada-22/">改訂2版 基礎からわかる Go言語</a></p>
<ul>
<li>
<span class="hatena-asin-detail-label">作者:</span> 古川昇</li>
<li>
<span class="hatena-asin-detail-label">出版社/メーカー:</span> シーアンドアール研究所</li>
<li>
<span class="hatena-asin-detail-label">発売日:</span> 2015/07/17</li>
<li>
<span class="hatena-asin-detail-label">メディア:</span> 単行本（ソフトカバー）</li>
<li><a href="http://d.hatena.ne.jp/asin/4863541783/kamawada-22" target="_blank">この商品を含むブログ (2件) を見る</a></li>
</ul>
</div>
<div class="hatena-asin-detail-foot"></div>
</div>


		</div>

		<div class="post-tags">
			
				
					<nav class="nav tags">
							<ul class="flat">
								
								<li><a href="/tags/golang">Golang</a></li>
								
							</ul>
					</nav>
				
			
		</div>
        <div id="fb-root"></div>
<script async defer crossorigin="anonymous" src="https://connect.facebook.net/ja_JP/sdk.js#xfbml=1&version=v5.0&appId=233306523373884&autoLogAppEvents=1"></script>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>

<div class="social-button-area">
  <ul class="social-button">
    <li>
      <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-show-count="false">Tweet</a>
    </li>
    <li>
      <span class="fb-share-button"  data-layout="button" data-size="small"><a target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fyusukebe.com%2fposts%2f2016%2f0118111838%2f;src=sdkpreparse" class="fb-xfbml-parse-ignore">シェア</a></span>
    </li>
    <li>
      <a href="https://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="basic-label-counter" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/v4/public/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a>
    </li>
  </ul>
</div>

<div class="disqus-area">
  
</div>

<ul class="pagination">
  
  <li class="page-item page-prev">
    <a href="https://yusukebe.com/posts/2016/0114095355/" class="page-link" aria-label="Previous"><span aria-hidden="true">← Rebuildメソッド Early 2016</span></a>
  </li>
  
  
  <li class="page-item page-next">
    <a href="https://yusukebe.com/posts/2016/0120190458/" class="page-link" aria-label="Next"><span aria-hidden="true">栄和堂を開店して2ヶ月が経った件 →</span></a>
  </li>
  
</ul>

	</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div> © Copyright yusukebe.com - Yusuke Wada |  <a href="https://github.com/vividvilla/ezhil">Ezhil theme</a> | Built with <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-492497-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

<script>feather.replace()</script>
</body>
</html>
