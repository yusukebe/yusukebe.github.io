+++
Categories = ["tech"]
Description = " どうしても「メロディー・雛・マークス」を出したい。それもPHPで。  DMM Webサービスを利用すれば、FANZAの情報が取ってこれる。DMM Webサービスはdmm.com、つまりNOT アダルトな一般の商品情報も取得できるが、dmm"
Tags = []
date = "2019-12-26T17:34:00+09:00"
title = "PHPでDMM Webサービスを叩いてメロディー・雛・マークスを出す"
author = "kamawada"
archive = ["2019"]
draft = false
+++


<p>どうしても「<strong>メロディー・雛・マークス</strong>」を出したい。それも<strong><a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a></strong>で。</p>

<p>DMM <a class="keyword" href="http://d.hatena.ne.jp/keyword/Web%A5%B5%A1%BC%A5%D3%A5%B9">Webサービス</a>を利用すれば、<a class="keyword" href="http://d.hatena.ne.jp/keyword/FANZA">FANZA</a>の情報が取ってこれる。DMM <a class="keyword" href="http://d.hatena.ne.jp/keyword/Web%A5%B5%A1%BC%A5%D3%A5%B9">Webサービス</a>は<a class="keyword" href="http://d.hatena.ne.jp/keyword/dmm.com">dmm.com</a>、つまり<code>NOT アダルト</code>な一般の商品情報も取得できるが、dmm.co.jp、つまり<a class="keyword" href="http://d.hatena.ne.jp/keyword/FANZA">FANZA</a>の結果が充実してて、中でも<strong>女優検索<a class="keyword" href="http://d.hatena.ne.jp/keyword/API">API</a></strong>なんてあってオシャレ！利用するためには、<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A2%A5%D5%A5%A3%A5%EA%A5%A8%A5%A4%A5%C8">アフィリエイト</a>利用登録をしてゲットできる<a class="keyword" href="http://d.hatena.ne.jp/keyword/API">API</a> IDと<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A2%A5%D5%A5%A3%A5%EA%A5%A8%A5%A4%A5%C8">アフィリエイト</a>IDが必要です。</p>

<ul>
<li><a href="https://affiliate.dmm.com/api/">https://affiliate.dmm.com/api/</a></li>
</ul>


<p>なんで<a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a>か？は置いておいて、おとといまで<code>php -S</code>でビルトインHTTPサーバが動くことすら知らなかった初心者です（なんか昔書いてた記憶があるけど…）。お手柔らかにお願いします。</p>

<pre class="code" data-lang="" data-unlink> $ php dmm.php 雛 </pre>


<p>と実行すると「雛」をキーワードとして<a class="keyword" href="http://d.hatena.ne.jp/keyword/FANZA">FANZA</a>から検索してきて、50名分の女優名とルビを表示するというしごく簡単なもの。キーワードはこのように<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B3%A5%DE%A5%F3%A5%C9%A5%E9%A5%A4%A5%F3">コマンドライン</a>引数で渡すものとし、もしなかった場合のデフォルトは空とする（「あ」からAV女優全員が検索される）。</p>

<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B3%A5%DE%A5%F3%A5%C9%A5%E9%A5%A4%A5%F3">コマンドライン</a>引数を解釈するために<code>argc</code>と<code>argv</code>という定義済みの変数を使う。<a class="keyword" href="http://d.hatena.ne.jp/keyword/API">API</a>へのアクセスは、パラメータを含んだURLに対しGETリク<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A8%A5%B9">エス</a>トをかけて、返ってきた<a class="keyword" href="http://d.hatena.ne.jp/keyword/JSON">JSON</a>をデコードする。パラメータは定数で定義した<a class="keyword" href="http://d.hatena.ne.jp/keyword/API">API</a> IDと<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%A2%A5%D5%A5%A3%A5%EA%A5%A8%A5%A4%A5%C8">アフィリエイト</a>IDを<code>api_id</code>と<code>affiliate_id</code>に入れて、<code>hits</code>と<code>keyword</code>で返却する女優の人数とキーワードを指定する。クエリ文字列を生成するのに<a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a>では、基本モジュールのURLsにある<code>http_build_query</code>関数を使うとよいみたい。HTTPのアクセスには<a class="keyword" href="http://d.hatena.ne.jp/keyword/cURL">cURL</a>を利用した。<a class="keyword" href="http://d.hatena.ne.jp/keyword/JSON">JSON</a>のデコードをする必要があるが、これもまた<a class="keyword" href="http://d.hatena.ne.jp/keyword/PHP">PHP</a>標準で<code>json_decode</code>という関数がある。標準バンザイ！</p>

<p>以下コード。</p>

<pre class="code lang-php" data-lang="php" data-unlink> &lt;?php

const API_ID = 'YOUR_API_ID';
const AFFILIATE_ID = 'YOUR_AFFILIATE_ID';

$keyword = $argc &gt; 1 ? $argv[1] : '';

$url = 'https://api.dmm.com/affiliate/v3/ActressSearch';
$params = array(
    'api_id' =&gt; API_ID,
    'affiliate_id' =&gt; AFFILIATE_ID,
    'hits' =&gt; 50,
    'keyword' =&gt; $keyword
);
$query = http_build_query($params);
$url .= "?" . $query;

echo "Search actresses from dmm.co.jp - Keyword: $keyword\n";
$ch = curl_init();
curl_setopt($ch, CURLOPT_URL, $url);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
$content = curl_exec($ch);
curl_close($ch);

$data = json_decode($content);
$actresses = $data-&gt;result-&gt;actress;

foreach ($actresses as $actress) {
    echo sprintf("- %s(%s)\n", $actress-&gt;name, $actress-&gt;ruby);
}
 </pre>


<p><a class="keyword" href="http://d.hatena.ne.jp/keyword/vim">vim</a>の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%B7%A5%F3%A5%BF%A5%C3%A5%AF%A5%B9">シンタックス</a>ハイライト、派手だな。</p>

<p>以下スクショ。</p>

<p><span itemscope itemtype="http://schema.org/Photograph"><img src="https://cdn-ak.f.st-hatena.com/images/fotolife/k/kamawada/20191226/20191226172909.png" alt="f:id:kamawada:20191226172909p:plain" title="f:id:kamawada:20191226172909p:plain" class="hatena-fotolife" itemprop="image"></span></p>

<p><strong>メロディー・雛・マークス</strong>でた！黒船襲来！</p>

