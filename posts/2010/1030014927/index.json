{
    "data" :  {
    "title": "自分のWallにポストするFacebookアプリを簡単に作る",
    "date": "2010-10-30 10:49:00 +0900 JST",
    "dir": "posts/2010/",
    "slug": "1030014927",
    "categories": ["tech"],
    "tags": []
}

---



<p>
Facebookやっていると飯どきの時間に空腹な人をターゲットとしてotsuneさんとかが、
焼肉の画像とかを貼付けて攻撃をしてきます。
これを画像爆撃と呼びます。
そこで、Facebook上でGoogleの画像検索を行いすぐに自分のWallにその画像をポストできれば、
こうした画像爆撃が簡単になると思い、
「<strong>画像検索爆撃</strong>」というFacebook上で動くアプリケーションを作ってみました。
</p>
<p>
<a href="http://www.facebook.com/apps/application.php?id=119186831476185">Facebook | 画像検索爆撃</a>
</p>
<p>
「<a href="http://developers.facebook.com/docs/">参考資料 - Facebook開発者</a>」。
ここの資料にある「Applications on Facebook.com」ってやつですね。
Facebookの公式ドキュメント、APIの仕様は読みやすいのですが、
例の記述が少ない部分があって試し試しでやらんといかんとです。
</p>
<p>
「Facebook上のアプリケーション」にはFBML/FBJSで組むタイプとページをiframeでFacebook.com上で読み込ませるタイプ2種類あります。
今回はjQueryを使ったJSオンリーで済ませようと思ったのでiframeで読み込ませるようにしました。
JSのAPIだけで認証及びWallへのポストができちゃうんで、
基本的にjs含むHTMLさえあればアプリケーションは完結します。
</p>
<p>
Facebook上でのアプリケーションの登録とかの仕方はめんどくさいんで省きます。
自分で調べてください。というかFacebook上でいじってればなんとなくわかります。
</p>
<p>
肝心なのはJSでFacebookのWallへ投稿するところです。
もっと詳しく言えば、指定した画像の添付付きで投稿するプロンプトを出すことです。
これは、ログインさえ済んでいれば、以下のコードでいけます。
</p>

<pre class="brush: perl"> var publish = {
    method: 'stream.publish',
    message: 'デフォルトのメッセージ',
    attachment: {
        name: //添付ファイルの名前,
        href: //添付ファイルのとび先URL,
        media: [
            {
                type: 'image',
                href: //画像のとび先URL,
                src: //画像のソースURL
            }
        ]
    },
    user_prompt_message: 'プロンプトのメッセージ'
};
FB.ui(publish);</pre>
<p>
FB.uiメソッドに{ method: 'stream.publish' }をはじめとしたハッシュを渡しているという感じです。
これを例えば画像をクリックした際に画像のプロパティを引き継いで発火させればいいのです。
ちなみにこのattachmentには mp3、swf も指定できます。
</p>
<p>
画像の検索部分は特にFacebook向けに工夫することなく、
GoogleのAPIを通常のJSON処理と同じように叩いています。
</p>
<p>
ということで全ソースコード71行を貼付けておきます。
</p>
<pre class="brush: perl"> var currentPage = 1;
var currentQuery = '';

$().ready(function(){
    FB.init({
        appId  : 'xxxxx',
        status : true,
        cookie : true,
        xfbml  : true
    });
    FB.getLoginStatus(function(response) {
        if (response.session) {
        } else {
            FB.login(function(response) {}, {perms:'publish_stream'});
        }
    });
    $('#form').submit(function(){
        var query = $("#query").val();
        searchImage( query );
        return false;
    });

});

function searchImage(query){
    if( query == currentQuery ){
        currentPage++;
    }else{
        currentPage = 1;
        currentQuery = query;
    }
    var start = ( currentPage - 1 ) * 8 ;
    var jsonURL = 'http://ajax.googleapis.com/ajax/services/search/images?v=1.0&amp;rsz=large&amp;q=' + query + '&amp;start=' + start + '&amp;callback=?';
    $.getJSON(jsonURL,function(json){
        if(json.responseData){
            showImage(json.responseData.results);
        }
    });
}

function showImage(items){
    jQuery.each(items,function(){
        var img = $('&lt;img/&gt;').attr('src',this.tbUrl);
        var a = $('&lt;a/&gt;').attr('href','#');
        a = setAnchor(a, this);
        $('#result').prepend(a.append(img));
    });
}

function setAnchor(a,item) {
    a.click(function(){
        var publish = {
            method: 'stream.publish',
            message: '',
            attachment: {
                name: item.contentNoFormatting,
                href: item.unescapedUrl,
                media: [
                    {
                        type: 'image',
                        href: item.unescapedUrl,
                        src: item.tbUrl
                    }
                ]
            },
            user_prompt_message: '自分のWallへポストする'
        };
        FB.ui(publish);
    });
    return a;
}</pre>


 
}
