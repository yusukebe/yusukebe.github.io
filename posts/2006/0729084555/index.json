{
    "data" :  {
    "title": "CustomFeed::YouTube_dev APIを使ってビデオ情報を取得させる",
    "date": "2006-07-29 17:45:00 +0900 JST",
    "dir": "posts/2006/",
    "slug": "0729084555",
    "categories": ["tech"],
    "tags": ["Perl"]
}

---



<p>
  YouTubeの特定のタグが付いたビデオページを投稿時間順にRSSで取得したい。
  YouTubeのサイトでもタグによるRSSフィードを以下のようなURLでも取得できるらしい(参考:<a href="http://cl.pocari.org/2006-05-28-1.html">[戯] YouTube でタグによる RSS フィードを取得するには</a>)。
</p>
<pre class="code">http://www.youtube.com/rss/tag/タグ.rss </pre>
<p>
  でも、これあんまりいけてなくて投稿時間順にソートすることができないんだよね。
  ということで「<strong><a href="http://subtech.g.hatena.ne.jp/keyword/%e3%81%9d%e3%82%8cPla">それPla(ry</a></strong>」精神、Plaggerでやってみる。Pluginを探すと<a href="http://mizzy.org/program/youtube_and_plagger02.html">mizzyさんが作った</a><a href="http://plagger.org/trac/browser/trunk/plagger/lib/Plagger/Plugin/CustomFeed/YouTube.pm">CustomFeed::YouTube</a>というぴったりのPluginがあるじゃないですか。video_date_uploadedでソートもできる。これはいけるぞ！と思ってRSSを作ってみたが問題がひとつある。RSSで言うとdc:date、pubDateといった<strong>更新時間が取得できない</strong>のだ。個人的にRSSの魅力はこの更新時間が取得できて、ソートできる点だと感じているので、このままでは使えないなとう感触。そこで、mizzyさんのCustomFeed::YouTubeをハックして俺の希望通りのフィードを吐くようにしてみる。
</p>
<p>
  方針は、ビデオ情報に関しては<a href="http://www.youtube.com/dev">YouTube API</a>を利用して取得するというもの。
  CustomFeed::YouTubeはYouTubeの検索結果HTMLを解析して全ての情報を取得している。
  そこには投稿時間の情報が無いので取得できないという具合になっている。
  なので、CustomFeed::YouTubeで取得できるビデオのIDを利用して、そのままそのIDを引数にYouTube APIの <a href="http://www.youtube.com/dev_api_ref?m=youtube.videos.get_details">youtube.videos.get_details</a>というメソッドを呼び出してビデオ情報を取得する。
  以下がそのサブルーチン。
</p>
<pre class="code">sub get_details{
  my($dev_id,$video_id) = @_;
  my $youtube_url = "http://www.youtube.com/api2_rest?method=youtube.videos.get_details&amp;dev_id=$dev_id&amp;video_id=$video_id";

  my $youtube_xml = get ($youtube_url) or die("can't get xml");
  my $parser = XML::Simple-&gt;new();
  my $xml_ref = $parser-&gt;XMLin("$youtube_xml");
  
  return $xml_ref-&gt;{'video_details'};
} </pre>
<p>
  ビデオ情報を取得したらそのままフィードのアイテムに追加。
  ビデオの投稿時間upload_timeがUNIX時間で返ってくるので
</p>
<pre class="code">Plagger::Date-&gt;from_epoch($video_details-&gt;{upload_time}); </pre>
<p>
  としてRSSの日付形式に変換してやる。
</p>
<p>
  てなわけで、うまくハックできました→
  ソース(<a href="http://kamawada.com/~yusuke/yusukebe/archives/files/060729/YouTube_dev.txt">YouTube_dev.txt</a>)。Perl始めて間もないので何か変なとこあればアドバイスください。
  我が研究室、奥出研のタグ「oklab」に関するRSSはこんな感じです→
  <a href="http://www.kamawada.com/~yusuke/oklab/youtube/oklab.xml">http://www.kamawada.com/~yusuke/oklab/youtube/oklab.xml</a><br>
  ちょこちょこ利用しだしたPlagger、Pluginの書き方もわかってきたぞー。宮川さんとCustomFeed::YouTube作ったmizzyさんに感謝。
</p>


 
}
